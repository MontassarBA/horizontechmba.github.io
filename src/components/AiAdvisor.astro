---
import { getLangFromUrl } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);

const content = {
  en: {
    title: 'AI Advisor',
    greeting: "Welcome! I'm your HORIZONTECH MBA advisor. What engineering challenge can we solve together?",
    placeholder: 'Type your question...',
    send: 'Send',
    bookCta: 'Book a Free Consultation',
    contactCta: 'Contact Us',
    disclaimer: 'AI-powered answers. For precise quotes, contact us directly.',
    close: 'Close',
    thinking: 'Thinking...',
    error: 'Something went wrong. Please try again.',
    rateLimit: 'Too many messages. Please wait a moment.',
    teaserTooltip: 'Need quick help? Ask one question.',
    suggestions: [
      'Our embedded project is delayed. Can you help recover?',
      'Can you support IEC 62304 / ISO 14971 compliance?',
      'How do you scope a firmware + cloud MVP budget?',
    ],
  },
  fr: {
    title: 'Conseiller IA',
    greeting: "Bienvenue ! Je suis votre conseiller HORIZONTECH MBA. Quel défi d'ingénierie pouvons-nous résoudre ensemble ?",
    placeholder: 'Tapez votre question...',
    send: 'Envoyer',
    bookCta: 'Réserver une consultation gratuite',
    contactCta: 'Nous contacter',
    disclaimer: 'Réponses générées par IA. Pour un devis précis, contactez-nous.',
    close: 'Fermer',
    thinking: 'Réflexion...',
    error: 'Une erreur est survenue. Veuillez réessayer.',
    rateLimit: 'Trop de messages. Veuillez patienter.',
    teaserTooltip: 'Besoin d\'aide rapide ? Posez une question.',
    suggestions: [
      'Notre projet embarque est en retard. Pouvez-vous aider ?',
      'Pouvez-vous couvrir IEC 62304 / ISO 14971 ?',
      "Comment cadrez-vous le budget d'un MVP firmware + cloud ?",
    ],
  },
};

const t = content[lang] || content.en;
const bookingUrl = 'https://outlook.office.com/book/HORIZONTECHMBAInc1@horizontechmba.com/?ismsaljsauthenabled';
const contactUrl = lang === 'fr' ? '/fr/contact' : '/en/contact';
const aiAdvisorApiUrl = import.meta.env.PUBLIC_AI_ADVISOR_API_URL || 'https://horizontech-ai.montassar-benabdallah.workers.dev';
---

<!-- Floating AI Advisor Button -->
<button
  id="ai-advisor-btn"
  aria-label={t.title}
  aria-controls="ai-advisor-panel"
  aria-expanded="false"
  class="fixed bottom-20 right-6 z-[45] w-14 h-14 rounded-full shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-500 flex items-center justify-center group liquid-glass-btn"
>
  <!-- Chat icon -->
  <svg id="ai-icon-chat" class="w-7 h-7 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
  </svg>
  <!-- Close icon (hidden by default) -->
  <svg id="ai-icon-close" class="w-7 h-7 hidden transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
  </svg>
  <!-- Pulse animation -->
  <span id="ai-pulse" class="absolute inset-0 rounded-full bg-primary-400/50 animate-ping opacity-25 pointer-events-none"></span>
</button>

<!-- Tooltip Teaser (hidden by default) -->
<div
  id="ai-tooltip-teaser"
  role="tooltip"
  class="fixed bottom-[9.25rem] right-6 z-[44] hidden opacity-0 translate-y-1 scale-[0.98] transition-all duration-300 pointer-events-none"
>
  <div class="bg-white/90 backdrop-blur-lg rounded-xl px-3 py-2 shadow-lg border border-primary-200/45 max-w-[220px]">
    <p class="text-xs text-gray-800 font-medium">{t.teaserTooltip}</p>
    <div class="absolute -bottom-1.5 right-8 w-3 h-3 bg-white/95 border-r border-b border-primary-200/50 transform rotate-45"></div>
  </div>
</div>

<!-- Chat Panel -->
<div
  id="ai-advisor-panel"
  role="dialog"
  aria-modal="false"
  aria-labelledby="ai-advisor-title"
  aria-hidden="true"
  tabindex="-1"
  class="fixed bottom-36 right-6 z-[45] w-[360px] hidden flex-col rounded-3xl overflow-hidden transition-all duration-500 opacity-0 translate-y-4 pointer-events-none liquid-glass-panel"
  style="max-width: calc(100vw - 2rem); max-height: calc(100dvh - 6rem); height: min(560px, calc(100vh - 6rem));"
>
  <!-- Header -->
  <div class="liquid-glass-header text-white px-5 py-4 flex items-center justify-between flex-shrink-0">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 bg-white/90 backdrop-blur-sm rounded-2xl flex items-center justify-center border border-white/50 shadow-md">
        <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19 14.5M14.25 3.104c.251.023.501.05.75.082M19 14.5l-2.47 2.47a2.25 2.25 0 01-1.59.659H9.06a2.25 2.25 0 01-1.591-.659L5 14.5m14 0V17a2 2 0 01-2 2H7a2 2 0 01-2-2v-2.5" />
        </svg>
      </div>
      <div>
        <h3 id="ai-advisor-title" class="font-semibold text-sm">{t.title}</h3>
        <p class="text-white/70 text-xs">HORIZONTECH MBA</p>
      </div>
    </div>
    <button id="ai-close-btn" type="button" aria-label={t.close} class="w-8 h-8 rounded-xl hover:bg-white/20 backdrop-blur-sm flex items-center justify-center transition-all duration-300">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Messages Area -->
  <div id="ai-messages" aria-live="polite" aria-relevant="additions text" class="flex-1 min-h-0 overflow-y-auto p-4 space-y-3 liquid-glass-messages">
    <!-- Greeting -->
    <div class="flex gap-2.5">
      <div class="w-7 h-7 bg-primary-500/25 backdrop-blur-sm rounded-xl flex items-center justify-center flex-shrink-0 mt-0.5 border border-primary-500/35">
        <svg class="w-4 h-4 text-primary-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19 14.5" />
        </svg>
      </div>
      <div class="bg-primary-50/60 backdrop-blur-lg rounded-2xl rounded-tl-sm px-4 py-2.5 max-w-[85%] border border-primary-100/40 shadow-md">
        <p class="text-sm text-gray-900">{t.greeting}</p>
      </div>
    </div>

    <!-- Quick Suggestions -->
    <div id="ai-suggestions" class="flex flex-wrap gap-2 pl-9 pr-1 pb-1">
      {t.suggestions.map((s) => (
        <button
          type="button"
          class="ai-suggestion text-xs leading-tight px-3 py-1.5 bg-primary-500/20 backdrop-blur-sm text-primary-900 rounded-full hover:bg-primary-500/30 transition-all duration-300 border border-primary-500/30 font-medium"
          data-message={s}
        >
          {s}
        </button>
      ))}
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="px-4 pb-2 flex gap-2 flex-shrink-0 relative z-[2]">
    <a
      id="ai-booking-cta"
      href={bookingUrl}
      target="_blank"
      rel="noopener noreferrer"
      class="flex-1 text-center text-xs px-3 py-2.5 bg-gradient-to-r from-primary-600 to-primary-500 text-white rounded-xl hover:from-primary-500 hover:to-primary-400 transition-all duration-300 font-bold border border-primary-400/30 shadow-lg shadow-primary-500/20 hover:shadow-xl hover:shadow-primary-500/30 hover:-translate-y-0.5"
    >
      {t.bookCta}
    </a>
    <a
      id="ai-contact-cta"
      href={contactUrl}
      class="flex-1 text-center text-xs px-3 py-2.5 bg-white/80 backdrop-blur-md text-gray-800 rounded-xl hover:bg-white/95 transition-all duration-300 font-semibold border border-gray-200/50 shadow-md hover:shadow-lg hover:-translate-y-0.5"
    >
      {t.contactCta}
    </a>
  </div>

  <!-- Input Area -->
  <div class="px-4 pb-3 flex-shrink-0 relative z-[2]">
    <form id="ai-form" class="flex gap-2">
      <input
        id="ai-input"
        type="text"
        maxlength="500"
        placeholder={t.placeholder}
        autocomplete="off"
        class="flex-1 px-4 py-2.5 text-sm border border-white/40 rounded-2xl focus:ring-2 focus:ring-primary-400/50 focus:border-primary-400/60 outline-none bg-white/35 backdrop-blur-sm transition-all duration-300 placeholder:text-gray-500 text-gray-900"
      />
      <button
        id="ai-send"
        type="submit"
        aria-label={t.send}
        class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-700 backdrop-blur-sm hover:from-primary-400 hover:to-primary-600 text-white rounded-2xl flex items-center justify-center transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0 shadow-lg shadow-primary-500/25 border border-white/30"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
      </button>
    </form>
    <p class="text-[10px] text-gray-600 mt-1.5 text-center relative z-[2]">{t.disclaimer}</p>
    <button id="ai-manage-consent" type="button" class="mt-1 text-[10px] text-primary-800 underline underline-offset-2 hover:text-primary-900 transition-colors w-full text-center font-medium">
      {lang === 'fr' ? 'G\u00e9rer les cookies' : 'Manage Cookies'}
    </button>
  </div>
</div>

<script is:inline define:vars={{ lang, AI_ENDPOINT: aiAdvisorApiUrl }}>
(function () {
  const COOKIE_NAME = 'horizontech_cookie_consent';
  const cleanEndpoint = String(AI_ENDPOINT || '').replace(/\/+$/, '');
  const ENDPOINT = /\/chat$/i.test(cleanEndpoint) ? cleanEndpoint : (cleanEndpoint + '/chat');
  const btn = document.getElementById('ai-advisor-btn');
  const panel = document.getElementById('ai-advisor-panel');
  const closeBtn = document.getElementById('ai-close-btn');
  const bookingCta = document.getElementById('ai-booking-cta');
  const contactCta = document.getElementById('ai-contact-cta');
  const manageConsentBtn = document.getElementById('ai-manage-consent');
  const form = document.getElementById('ai-form');
  const input = document.getElementById('ai-input');
  const messagesEl = document.getElementById('ai-messages');
  const iconChat = document.getElementById('ai-icon-chat');
  const iconClose = document.getElementById('ai-icon-close');
  const pulse = document.getElementById('ai-pulse');
  const suggestionsEl = document.getElementById('ai-suggestions');

  if (!btn || !panel || !closeBtn || !form || !input || !messagesEl || !iconChat || !iconClose || !pulse) return;

  const strings = {
    en: {
      thinking: 'Thinking...',
      error: 'Something went wrong. Please try again.',
      networkError: 'Network error. Please check your connection and try again.',
      unavailable: 'AI service is temporarily unavailable. Please retry in a moment.',
      forbidden: 'AI chat is not enabled for this domain yet.',
      rateLimit: 'Too many messages. Please wait a moment.',
      consentRequired: 'Please enable performance or analytics cookies to use the AI advisor.',
    },
    fr: {
      thinking: 'R\u00e9flexion...',
      error: 'Une erreur est survenue. Veuillez r\u00e9essayer.',
      networkError: 'Erreur reseau. Verifiez votre connexion puis reessayez.',
      unavailable: 'Le service IA est temporairement indisponible. Reessayez dans un instant.',
      forbidden: 'Le chat IA n est pas encore active pour ce domaine.',
      rateLimit: 'Trop de messages. Veuillez patienter.',
      consentRequired: 'Veuillez activer les cookies de performance ou analytiques pour utiliser le conseiller IA.',
    },
  };
  const t = strings[lang] || strings.en;

  let isOpen = false;
  let isLoading = false;
  let history = [];

  function updateRecaptchaOffset() {
    const isMobile = window.matchMedia('(max-width: 640px)').matches;
    if (!isMobile) {
      document.documentElement.style.setProperty('--ai-recaptcha-offset', '0px');
      return;
    }

    const badge = document.querySelector('.grecaptcha-badge');
    if (!badge) {
      document.documentElement.style.setProperty('--ai-recaptcha-offset', '0px');
      return;
    }

    const style = window.getComputedStyle(badge);
    const hidden = style.display === 'none' || style.visibility === 'hidden' || Number.parseFloat(style.opacity || '1') === 0;
    if (hidden) {
      document.documentElement.style.setProperty('--ai-recaptcha-offset', '0px');
      return;
    }

    const rect = badge.getBoundingClientRect();
    const marginBottom = Number.parseFloat(style.marginBottom || '0') || 0;
    const offset = Math.max(0, Math.round(rect.height + marginBottom + 10));
    document.documentElement.style.setProperty('--ai-recaptcha-offset', `${offset}px`);
  }

  function track(eventName, payload) {
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      event: eventName,
      component: 'ai_advisor',
      lang: lang,
      ...payload,
    });
  }

  function getCookie(name) {
    const prefix = name + '=';
    const rawCookies = document.cookie ? document.cookie.split(';') : [];
    for (let i = 0; i < rawCookies.length; i++) {
      let value = rawCookies[i];
      while (value.charAt(0) === ' ') value = value.substring(1);
      if (value.indexOf(prefix) === 0) {
        try {
          return JSON.parse(decodeURIComponent(value.substring(prefix.length)));
        } catch (error) {
          return null;
        }
      }
    }
    return null;
  }

  function hasAiConsent() {
    const consent = getCookie(COOKIE_NAME);
    if (!consent || typeof consent !== 'object') return false;
    return Boolean(consent.performance || consent.analytics);
  }

  function openCookiePreferences() {
    if (typeof window.openCookiePreferences === 'function') {
      window.openCookiePreferences();
      track('ai_chat_open_cookie_preferences', {});
    }
  }

  function togglePanel() {
    isOpen = !isOpen;
    if (isOpen) {
      hideTooltipTeaser(true);
      panel.classList.remove('hidden', 'pointer-events-none');
      panel.classList.add('flex');
      requestAnimationFrame(() => {
        panel.classList.remove('opacity-0', 'translate-y-4');
        panel.classList.add('opacity-100', 'translate-y-0');
      });
      button.setAttribute('aria-expanded', 'true');
      panel.setAttribute('aria-hidden', 'false');
      iconChat.classList.add('hidden');
      iconClose.classList.remove('hidden');
      pulse.classList.add('hidden');
      input.focus();
      track('ai_chat_opened', {});
    } else {
      panel.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
      panel.classList.remove('opacity-100', 'translate-y-0');
      setTimeout(() => {
        panel.classList.add('hidden');
        panel.classList.remove('flex');
      }, 300);
      panel.setAttribute('aria-hidden', 'true');
      btn.setAttribute('aria-expanded', 'false');
      iconChat.classList.remove('hidden');
      iconClose.classList.add('hidden');
      track('ai_chat_closed', {});
    }
  }

  function addMessage(text, role) {
    const wrapper = document.createElement('div');
    wrapper.className = role === 'user' ? 'flex justify-end' : 'flex gap-2.5';

    if (role === 'assistant') {
      wrapper.innerHTML =
        '<div class="w-7 h-7 bg-primary-500/25 backdrop-blur-sm rounded-xl flex items-center justify-center flex-shrink-0 mt-0.5 border border-primary-500/35">' +
        '<svg class="w-4 h-4 text-primary-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19 14.5" /></svg>' +
        '</div>' +
        '<div class="bg-primary-50/60 backdrop-blur-lg rounded-2xl rounded-tl-sm px-4 py-2.5 max-w-[85%] border border-primary-100/40 shadow-md">' +
        '<p class="text-sm text-gray-900 whitespace-pre-wrap">' + escapeHtml(text) + '</p>' +
        '</div>';
    } else {
      wrapper.innerHTML =
        '<div class="bg-gradient-to-br from-primary-500 to-primary-700 backdrop-blur-lg text-white rounded-2xl rounded-tr-sm px-4 py-2.5 max-w-[85%] border border-primary-400/30 shadow-lg">' +
        '<p class="text-sm whitespace-pre-wrap">' + escapeHtml(text) + '</p>' +
        '</div>';
    }

    messagesEl.appendChild(wrapper);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return wrapper;
  }

  function addThinking() {
    const wrapper = document.createElement('div');
    wrapper.id = 'ai-thinking';
    wrapper.className = 'flex gap-2.5';
    wrapper.innerHTML =
      '<div class="w-7 h-7 bg-primary-500/25 backdrop-blur-sm rounded-xl flex items-center justify-center flex-shrink-0 mt-0.5 border border-primary-500/35">' +
      '<svg class="w-4 h-4 text-primary-700 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>' +
      '</div>' +
      '<div class="bg-primary-50/60 backdrop-blur-lg rounded-2xl rounded-tl-sm px-4 py-2.5 border border-primary-100/40 shadow-md">' +
      '<p class="text-sm text-gray-600 animate-pulse">' + t.thinking + '</p>' +
      '</div>';
    messagesEl.appendChild(wrapper);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function removeThinking() {
    const el = document.getElementById('ai-thinking');
    if (el) el.remove();
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  async function sendMessage(text) {
    const trimmed = text.trim();
    if (isLoading || !trimmed) return;

    if (!hasAiConsent()) {
      addMessage(t.consentRequired, 'assistant');
      track('ai_chat_blocked_no_consent', {});
      return;
    }

    isLoading = true;
    input.disabled = true;

    if (suggestionsEl) suggestionsEl.classList.add('hidden');

    addMessage(trimmed, 'user');
    history.push({ role: 'user', content: trimmed });
    track('ai_chat_message_sent', { chars: trimmed.length });

    addThinking();

    try {
      const res = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: trimmed,
          lang: lang,
          history: history.slice(-6),
        }),
      });

      removeThinking();

      if (res.status === 429) {
        addMessage(t.rateLimit, 'assistant');
        track('ai_chat_rate_limited', {});
      } else if (res.status === 403) {
        addMessage(t.forbidden, 'assistant');
        track('ai_chat_response_error', { status: 403 });
      } else if (res.status >= 500) {
        addMessage(t.unavailable, 'assistant');
        track('ai_chat_response_error', { status: res.status });
      } else if (!res.ok) {
        addMessage(t.error, 'assistant');
        track('ai_chat_response_error', { status: res.status });
      } else {
        const data = await res.json();
        const reply = data.response || t.error;
        addMessage(reply, 'assistant');
        history.push({ role: 'assistant', content: reply });
        track('ai_chat_response_received', { chars: reply.length });
      }
    } catch (err) {
      removeThinking();
      addMessage(t.networkError, 'assistant');
      track('ai_chat_response_error', { status: 'network' });
    }

    isLoading = false;
    input.disabled = false;
    input.value = '';
    input.focus();
  }

  btn.addEventListener('click', togglePanel);
  closeBtn.addEventListener('click', togglePanel);
  if (manageConsentBtn) manageConsentBtn.addEventListener('click', openCookiePreferences);
  if (bookingCta) bookingCta.addEventListener('click', () => track('ai_chat_cta_click', { cta: 'booking' }));
  if (contactCta) contactCta.addEventListener('click', () => track('ai_chat_cta_click', { cta: 'contact' }));

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    sendMessage(input.value);
  });

  document.querySelectorAll('.ai-suggestion').forEach((el) => {
    el.addEventListener('click', () => {
      sendMessage(el.dataset.message || '');
    });
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isOpen) togglePanel();
  });

  // Keep chatbot clear of reCAPTCHA badge on iPhone/small screens.
  updateRecaptchaOffset();
  setTimeout(updateRecaptchaOffset, 1200);
  setTimeout(updateRecaptchaOffset, 3000);
  window.addEventListener('resize', updateRecaptchaOffset);
  window.addEventListener('orientationchange', updateRecaptchaOffset);

  const recaptchaObserver = new MutationObserver(updateRecaptchaOffset);
  recaptchaObserver.observe(document.body, { childList: true, subtree: true });

  window.addEventListener('cookieConsentUpdated', function () {
    track('ai_chat_consent_updated', { enabled: hasAiConsent() });
  });

  // Tooltip Teaser Logic: show once per page load on key pages
  const tooltipTeaser = document.getElementById('ai-tooltip-teaser');
  const TEASER_DELAY = 5000; // 5 seconds
  let teaserShowTimer = null;
  let teaserHideTimer = null;
  let teaserShown = false;
  
  function isKeyPage() {
    const path = window.location.pathname;
    // Pages clés: home, services, about, contact
    return path === '/' || 
           path === '/en/' || 
           path === '/fr/' ||
           path.includes('/services') || 
           path.includes('/about') || 
           path.includes('/contact');
  }

  function shouldShowTeaser() {
    // Show only once per page load
    if (teaserShown) return false;
    // Check if on key page
    if (!isKeyPage()) return false;
    // Check if chatbot not already opened
    if (isOpen) return false;
    // Only show when tab is visible
    if (document.visibilityState !== 'visible') return false;
    return true;
  }

  function hideTooltipTeaser(immediate = false) {
    if (!tooltipTeaser) return;
    if (teaserHideTimer) {
      clearTimeout(teaserHideTimer);
      teaserHideTimer = null;
    }

    tooltipTeaser.classList.remove('opacity-100', 'translate-y-0', 'scale-100');
    tooltipTeaser.classList.add('opacity-0', 'translate-y-1', 'scale-[0.98]');

    if (immediate) {
      tooltipTeaser.classList.add('hidden');
      return;
    }

    teaserHideTimer = setTimeout(() => {
      tooltipTeaser.classList.add('hidden');
    }, 260);
  }

  function showTooltipTeaser() {
    if (!tooltipTeaser || !shouldShowTeaser()) return;
    teaserShown = true;

    tooltipTeaser.classList.remove('hidden');
    requestAnimationFrame(() => {
      tooltipTeaser.classList.remove('opacity-0', 'translate-y-1', 'scale-[0.98]');
      tooltipTeaser.classList.add('opacity-100', 'translate-y-0', 'scale-100');
    });
    
    track('ai_chat_teaser_shown', { page: window.location.pathname });
  }

  function scheduleTooltipTeaser(delayMs = TEASER_DELAY) {
    if (teaserShowTimer) clearTimeout(teaserShowTimer);
    teaserShowTimer = setTimeout(() => {
      if (!shouldShowTeaser()) return;
      showTooltipTeaser();
    }, delayMs);
  }

  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState !== 'visible') {
      hideTooltipTeaser(true);
      return;
    }
    scheduleTooltipTeaser(2500);
  });

  // Show teaser after delay
  scheduleTooltipTeaser();

  // Hide pulse animation after 10s
  setTimeout(() => {
    if (pulse) pulse.classList.add('hidden');
  }, 10000);
})();
</script>

<style>
  :root {
    --ai-recaptcha-offset: 0px;
  }

  /* === True Apple Liquid Glass === */

  .liquid-glass-btn {
    background: linear-gradient(135deg, rgba(0, 153, 153, 0.7), rgba(0, 120, 120, 0.8));
    backdrop-filter: blur(20px) saturate(200%);
    -webkit-backdrop-filter: blur(20px) saturate(200%);
    border: 0.5px solid rgba(255, 255, 255, 0.4);
    box-shadow:
      0 8px 32px rgba(0, 0, 0, 0.15),
      inset 0 0.5px 0 rgba(255, 255, 255, 0.5),
      inset 0 -0.5px 0 rgba(0, 0, 0, 0.15);
    color: white;
  }
  .liquid-glass-btn:hover {
    box-shadow:
      0 12px 40px rgba(0, 0, 0, 0.2),
      inset 0 0.5px 0 rgba(255, 255, 255, 0.6),
      inset 0 -0.5px 0 rgba(0, 0, 0, 0.15);
  }

  .liquid-glass-panel {
    background: linear-gradient(
      160deg,
      rgba(255, 255, 255, 0.35),
      rgba(255, 255, 255, 0.18),
      rgba(255, 255, 255, 0.25)
    );
    backdrop-filter: blur(60px) saturate(180%) brightness(108%);
    -webkit-backdrop-filter: blur(60px) saturate(180%) brightness(108%);
    border: 0.5px solid rgba(255, 255, 255, 0.45);
    box-shadow:
      0 24px 80px rgba(0, 0, 0, 0.15),
      0 8px 32px rgba(0, 0, 0, 0.08),
      inset 0 0.5px 0 rgba(255, 255, 255, 0.7),
      inset 0 -0.5px 0 rgba(0, 0, 0, 0.08);
  }
  /* Top highlight â€” the specular reflection Apple uses */
  .liquid-glass-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 45%;
    background: linear-gradient(
      180deg,
      rgba(255, 255, 255, 0.22),
      rgba(255, 255, 255, 0.04) 60%,
      transparent
    );
    border-radius: 1.5rem 1.5rem 0 0;
    pointer-events: none;
    z-index: 1;
  }
  /* Bottom subtle shadow edge */
  .liquid-glass-panel::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 30%;
    background: linear-gradient(
      0deg,
      rgba(0, 0, 0, 0.03),
      transparent
    );
    border-radius: 0 0 1.5rem 1.5rem;
    pointer-events: none;
    z-index: 1;
  }

  .liquid-glass-header {
    background: linear-gradient(
      135deg,
      rgba(0, 153, 153, 0.75),
      rgba(0, 120, 120, 0.85)
    );
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border-bottom: 0.5px solid rgba(255, 255, 255, 0.25);
    position: relative;
    z-index: 2;
  }
  /* Top edge highlight on header */
  .liquid-glass-header::after {
    content: '';
    position: absolute;
    top: 0;
    left: 10%;
    right: 10%;
    height: 0.5px;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.5),
      transparent
    );
  }

  .liquid-glass-messages {
    position: relative;
    z-index: 2;
    background: transparent;
  }

  @keyframes ai-fade-in {
    from { opacity: 0; transform: translateY(1rem) scale(0.96); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  #ai-advisor-panel.flex {
    animation: ai-fade-in 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  #ai-messages::-webkit-scrollbar {
    width: 3px;
  }
  #ai-messages::-webkit-scrollbar-track {
    background: transparent;
  }
  #ai-messages::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.25);
    border-radius: 3px;
  }
  #ai-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.4);
  }

  /* Glass input area */
  #ai-form {
    position: relative;
    z-index: 2;
  }
  .px-4.pb-2 {
    position: relative;
    z-index: 2;
  }
  .px-4.pb-3 {
    position: relative;
    z-index: 2;
  }

  /* iPhone and small-screen tuning */
  @media (max-width: 640px) {
    #ai-advisor-btn {
      right: 1rem;
      bottom: calc(1rem + env(safe-area-inset-bottom) + var(--ai-recaptcha-offset));
    }

    #ai-advisor-panel {
      left: 0.75rem;
      right: 0.75rem;
      width: auto;
      max-width: none;
      bottom: calc(5.25rem + env(safe-area-inset-bottom) + var(--ai-recaptcha-offset));
      height: min(72dvh, calc(100dvh - 7rem - env(safe-area-inset-bottom)));
      border-radius: 1.25rem;
    }

    #ai-tooltip-teaser {
      bottom: calc(5.5rem + env(safe-area-inset-bottom) + var(--ai-recaptcha-offset));
      right: 1rem;
    }

    #ai-messages {
      padding: 0.875rem;
    }

    #ai-suggestions {
      padding-left: 0;
      padding-right: 0;
      gap: 0.5rem;
    }

    .ai-suggestion {
      font-size: 0.75rem;
      line-height: 1.2;
      padding: 0.4rem 0.65rem;
      width: 100%;
      border-radius: 0.9rem;
      text-align: center;
    }

    #ai-input {
      font-size: 16px; /* Prevent iOS Safari auto-zoom on focus */
    }
  }
</style>
